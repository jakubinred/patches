diff -ruN a/.gitignore b/.gitignore
--- a/.gitignore	1970-01-01 01:00:00.000000000 +0100
+++ b/.gitignore	2023-06-08 23:18:47.000000000 +0200
@@ -0,0 +1,4 @@
+vendor
+composer.lock
+node_modules
+package.lock
diff -ruN a/LICENSE.txt b/LICENSE.txt
--- a/LICENSE.txt	2016-11-17 00:57:05.000000000 +0100
+++ b/LICENSE.txt	1970-01-01 01:00:00.000000000 +0100
@@ -1,339 +0,0 @@
-                    GNU GENERAL PUBLIC LICENSE
-                       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
- 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-                            Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Lesser General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-                    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-                            NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
-
-                     END OF TERMS AND CONDITIONS
-
-            How to Apply These Terms to Your New Programs
-
-  If you develop a new program, and you want it to be of the greatest
-possible use to the public, the best way to achieve this is to make it
-free software which everyone can redistribute and change under these terms.
-
-  To do so, attach the following notices to the program.  It is safest
-to attach them to the start of each source file to most effectively
-convey the exclusion of warranty; and each file should have at least
-the "copyright" line and a pointer to where the full notice is found.
-
-    <one line to give the program's name and a brief idea of what it does.>
-    Copyright (C) <year>  <name of author>
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License along
-    with this program; if not, write to the Free Software Foundation, Inc.,
-    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-
-Also add information on how to contact you by electronic and paper mail.
-
-If the program is interactive, make it output a short notice like this
-when it starts in an interactive mode:
-
-    Gnomovision version 69, Copyright (C) year name of author
-    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
-    This is free software, and you are welcome to redistribute it
-    under certain conditions; type `show c' for details.
-
-The hypothetical commands `show w' and `show c' should show the appropriate
-parts of the General Public License.  Of course, the commands you use may
-be called something other than `show w' and `show c'; they could even be
-mouse-clicks or menu items--whatever suits your program.
-
-You should also get your employer (if you work as a programmer) or your
-school, if any, to sign a "copyright disclaimer" for the program, if
-necessary.  Here is a sample; alter the names:
-
-  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
-  `Gnomovision' (which makes passes at compilers) written by James Hacker.
-
-  <signature of Ty Coon>, 1 April 1989
-  Ty Coon, President of Vice
-
-This General Public License does not permit incorporating your program into
-proprietary programs.  If your program is a subroutine library, you may
-consider it more useful to permit linking proprietary applications with the
-library.  If this is what you want to do, use the GNU Lesser General
-Public License instead of this License.
diff -ruN a/PATCHES.txt b/PATCHES.txt
--- a/PATCHES.txt	1970-01-01 01:00:00.000000000 +0100
+++ b/PATCHES.txt	2023-06-08 23:18:46.000000000 +0200
@@ -0,0 +1,7 @@
+This file was automatically generated by Composer Patches (https://github.com/cweagans/composer-patches)
+Patches applied to this directory:
+
+Drupal 10 & CKEditor 5 readiness
+Source: https://www.drupal.org/files/issues/2023-05-05/entity_embed-3272732-80.patch
+
+
diff -ruN a/composer.json b/composer.json
--- a/composer.json	2022-10-20 16:16:12.000000000 +0200
+++ b/composer.json	2023-06-08 23:18:45.000000000 +0200
@@ -7,6 +7,7 @@
         "drupal/embed": "^1.5"
     },
     "require-dev": {
+        "drupal/ckeditor": "^1",
         "drupal/entity_browser": "^2.2"
     }
 }
diff -ruN a/entity_embed.api.php b/entity_embed.api.php
--- a/entity_embed.api.php	2022-10-20 16:16:12.000000000 +0200
+++ b/entity_embed.api.php	2023-06-08 23:18:45.000000000 +0200
@@ -1,5 +1,8 @@
 <?php
 
+use Drupal\file\FileInterface;
+use Drupal\node\NodeInterface;
+use Drupal\Core\Entity\EntityInterface;
 /**
  * @file
  * Hooks provided by the Entity Embed module.
@@ -40,17 +43,17 @@
   $entity = $contexts['entity'];
 
   // For video and audio files, limit the available options to the media player.
-  if ($entity instanceof \Drupal\file\FileInterface && in_array($entity->bundle(), ['audio', 'video'])) {
+  if ($entity instanceof FileInterface && in_array($entity->bundle(), ['audio', 'video'])) {
     $definitions = array_intersect_key($definitions, array_flip(['file:jwplayer_formatter']));
   }
 
   // For images, use the image formatter.
-  if ($entity instanceof \Drupal\file\FileInterface && in_array($entity->bundle(), ['image'])) {
+  if ($entity instanceof FileInterface && in_array($entity->bundle(), ['image'])) {
     $definitions = array_intersect_key($definitions, array_flip(['image:image']));
   }
 
   // For nodes, use the default option.
-  if ($entity instanceof \Drupal\node\NodeInterface) {
+  if ($entity instanceof NodeInterface) {
     $definitions = array_intersect_key($definitions, array_flip(['entity_reference:entity_reference_entity_view']));
   }
 }
@@ -63,7 +66,7 @@
  * @param \Drupal\Core\Entity\EntityInterface $entity
  *   The entity object.
  */
-function hook_entity_embed_context_alter(array &$context, \Drupal\Core\Entity\EntityInterface $entity) {
+function hook_entity_embed_context_alter(array &$context, EntityInterface $entity) {
   if (isset($context['overrides']) && is_array($context['overrides'])) {
     foreach ($context['overrides'] as $key => $value) {
       $entity->key = $value;
@@ -79,7 +82,7 @@
  * @param \Drupal\Core\Entity\EntityInterface $entity
  *   The entity object.
  */
-function hook_ENTITY_TYPE_embed_context_alter(array &$context, \Drupal\Core\Entity\EntityInterface $entity) {
+function hook_ENTITY_TYPE_embed_context_alter(array &$context, EntityInterface $entity) {
   if (isset($context['overrides']) && is_array($context['overrides'])) {
     foreach ($context['overrides'] as $key => $value) {
       $entity->key = $value;
@@ -101,7 +104,7 @@
  * @param array $context
  *   The context array.
  */
-function hook_entity_embed_alter(array &$build, \Drupal\Core\Entity\EntityInterface $entity, array &$context) {
+function hook_entity_embed_alter(array &$build, EntityInterface $entity, array &$context) {
   // Remove the contextual links.
   if (isset($build['#contextual_links'])) {
     unset($build['#contextual_links']);
@@ -118,7 +121,7 @@
  * @param array $context
  *   The context array.
  */
-function hook_ENTITY_TYPE_embed_alter(array &$build, \Drupal\Core\Entity\EntityInterface $entity, array &$context) {
+function hook_ENTITY_TYPE_embed_alter(array &$build, EntityInterface $entity, array &$context) {
   // Remove the contextual links.
   if (isset($build['#contextual_links'])) {
     unset($build['#contextual_links']);
diff -ruN a/entity_embed.info.yml b/entity_embed.info.yml
--- a/entity_embed.info.yml	2022-10-20 16:19:04.000000000 +0200
+++ b/entity_embed.info.yml	2023-06-08 23:18:44.000000000 +0200
@@ -1,15 +1,10 @@
 name: Entity Embed
 type: module
 description: 'Allows entities to be embedded using a text editor.'
-core_version_requirement: ^9.3
+core_version_requirement: ^9.3 || ^10
 package: Filters
 dependencies:
   - drupal:editor
   - embed:embed
   - drupal:filter
   - drupal:system
-
-# Information added by Drupal.org packaging script on 2022-10-20
-version: '8.x-1.3'
-project: 'entity_embed'
-datestamp: 1666275544
diff -ruN a/entity_embed.install b/entity_embed.install
--- a/entity_embed.install	2022-10-20 16:16:12.000000000 +0200
+++ b/entity_embed.install	2023-06-08 23:18:44.000000000 +0200
@@ -5,97 +5,9 @@
  * Contains install and update functions for Entity Embed.
  */
 
-use Drupal\Core\Entity\ContentEntityType;
-use Drupal\Core\StringTranslation\TranslatableMarkup;
-use Drupal\embed\Entity\EmbedButton;
-use Drupal\Core\Utility\UpdateException;
-
-/**
- * Convert entity embed buttons to embed buttons.
- *
- * @todo Can we reuse the existing UUID and save before deleting the old button?
- */
-function entity_embed_update_8001() {
-  $config_factory = \Drupal::configFactory();
-
-  foreach ($config_factory->listAll('entity_embed.embed_button.') as $config_name) {
-    $old_embed_button = $config_factory->getEditable($config_name);
-    $values = $old_embed_button->getRawData();
-
-    if (EmbedButton::load($values['id'])) {
-      throw new UpdateException('Unable to convert entity_embed.embed_button.' . $values['id'] . ' to embed.button.' . $values['id'] . ' since the latter already exists.');
-    }
-
-    // Move some data around.
-    $values['type_id'] = 'entity';
-    $values['type_settings'] = [
-      'entity_type' => $values['entity_type'],
-      'bundles' => array_keys(array_filter($values['entity_type_bundles'])),
-      'display_plugins' => array_keys(array_filter($values['display_plugins'])),
-    ];
-    $values['icon_uuid'] = $values['button_icon_uuid'];
-    unset($values['entity_type']);
-    unset($values['entity_type_bundles']);
-    unset($values['display_plugins']);
-    unset($values['button_icon_uuid']);
-
-    // Save the new embed button and delete the old one.
-    $embed_button = EmbedButton::create($values);
-    $embed_button->save();
-    $old_embed_button->delete();
-  }
-}
-
 /**
- * Updates the default mode settings.
- */
-function entity_embed_update_8002() {
-  \Drupal::configFactory()
-    ->getEditable('entity_embed.settings')
-    ->set('rendered_entity_mode', TRUE)
-    ->save();
-}
-
-/**
- * Updates allowed HTML for all filter configs that have an Entity Embed button.
- */
-function entity_embed_update_8003() {
-  $buttons = \Drupal::entityTypeManager()->getStorage('embed_button')->loadMultiple();
-  $filter_formats_with_embed_button = [];
-
-  // Get filter formats from editors with entity embed button.
-  foreach (\Drupal::entityTypeManager()->getStorage('editor')->loadMultiple() as $editor) {
-    foreach (new RecursiveIteratorIterator(new RecursiveArrayIterator($editor->getSettings())) as $settings_value) {
-      foreach ($buttons as $button) {
-        if ($settings_value == $button->id()) {
-          $filter_formats_with_embed_button[] = $editor->getFilterFormat();
-        }
-      }
-    }
-  }
-  foreach ($filter_formats_with_embed_button as $filter_format) {
-    foreach ($filter_format->filters()->getAll() as $filter) {
-      if (isset($filter->getConfiguration()['settings']['allowed_html'])) {
-        $allowed_html = $filter->getConfiguration()['settings']['allowed_html'];
-        if (strpos($allowed_html, 'data-entity-embed-settings')) {
-          $allowed_html = str_replace('data-entity-embed-settings', 'data-entity-embed-settings data-entity-embed-display-settings', $allowed_html);
-          $filter_format->setFilterConfig($filter->getPluginId(), ['settings' => ['allowed_html' => $allowed_html]]);
-          $filter_format->save();
-        }
-      }
-    }
-  }
-}
-
-/**
- * Adds new content entity type to remove dependency on node module.
- */
-function entity_embed_update_8004() {
-  \Drupal::entityDefinitionUpdateManager()->installEntityType(new ContentEntityType([
-    'id' => 'entity_embed_fake_entity',
-    'label' => new TranslatableMarkup('Fake entity type'),
-    'handlers' => [
-      'storage' => 'Drupal\\Core\\Entity\\ContentEntityNullStorage',
-    ],
-  ]));
++ * Implements hook_update_last_removed().
+  */
+function entity_embed_update_last_removed() {
+  return 8004;
 }
diff -ruN a/entity_embed.libraries.yml b/entity_embed.libraries.yml
--- a/entity_embed.libraries.yml	2022-10-20 16:16:12.000000000 +0200
+++ b/entity_embed.libraries.yml	2023-06-08 23:18:43.000000000 +0200
@@ -17,3 +17,20 @@
       css/entity_embed.filter.caption.css: {}
   dependencies:
     - filter/caption
+
+# CKEditor 5
+entity_embed:
+  js:
+    js/build/drupalentity.js: { minified: true }
+  dependencies:
+    - core/ckeditor5
+    - core/drupal
+
+admin.entity_embed:
+  js:
+    js/entity_embed.set_dynamic_icons.js: {}
+  dependencies:
+    - core/drupal
+    - core/jquery
+    - core/once
+    - core/drupalSettings
diff -ruN a/entity_embed.module b/entity_embed.module
--- a/entity_embed.module	2022-10-20 16:16:12.000000000 +0200
+++ b/entity_embed.module	2023-06-08 23:18:43.000000000 +0200
@@ -5,11 +5,18 @@
  * Framework for allowing entities to be embedded in CKEditor.
  */
 
+use Drupal\ckeditor5\Plugin\CKEditor5PluginDefinition;
+use Drupal\Component\Utility\Html;
+use Drupal\Core\Cache\Cache;
+use Drupal\Core\Entity\EntityInterface;
 use Drupal\Component\Serialization\Json;
 use Drupal\Core\Routing\RouteMatchInterface;
 use Drupal\Core\Form\FormStateInterface;
 use Drupal\Core\Field\FieldItemListInterface;
 use Drupal\Core\Entity\ContentEntityInterface;
+use Drupal\embed\EmbedButtonInterface;
+use Drupal\embed\Entity\EmbedButton;
+use Drupal\entity_embed\Event\EmbedButtonEvent;
 
 /**
  * Implements hook_help().
@@ -298,3 +305,57 @@
     $element['#attributes']['data-entity_embed-host-entity-langcode'] = $items->getEntity()->language()->getId();
   }
 }
+
+/**
+ * Implements hook_ENTITY_TYPE_presave().
+ */
+function entity_embed_embed_button_presave(EntityInterface $entity) {
+  // Invalidate the CKEditor 5 plugin cache, so new toolbar items will appear
+  // based on which Embed Buttons are configured.
+  /** @var \Drupal\ckeditor5\Plugin\CKEditor5PluginManagerInterface $ckeditor5_plugin_manager */
+  if (\Drupal::hasService('plugin.manager.ckeditor5.plugin')) {
+    $ckeditor5_plugin_manager = \Drupal::service('plugin.manager.ckeditor5.plugin');
+    $ckeditor5_plugin_manager->clearCachedDefinitions();
+    // @see entity_embed_library_info_alter()
+    Cache::invalidateTags(['library_info']);
+  }
+}
+
+/**
+ * Implements hook_library_info_alter().
+ */
+function entity_embed_library_info_alter(&$libraries, $extension) {
+  // Create the drupalSettings dynamically based on embed buttons for the
+  // admin library.
+  if ($extension === 'entity_embed' && isset($libraries['admin.entity_embed'])) {
+    $embed_buttons = \Drupal::entityTypeManager()
+      ->getStorage('embed_button')
+      ->loadMultiple();
+    foreach ($embed_buttons as $embed_button) {
+      $libraries['admin.entity_embed']['drupalSettings']['embedButtons'][$embed_button->id()] = [
+        'id' => $embed_button->id(),
+        'icon' => $embed_button->getIconUrl(),
+      ];
+
+    }
+    $libraries['admin.entity_embed']['drupalSettings']['modulePath'] = \Drupal::service('extension.list.module')->getPath('entity_embed');
+  }
+}
+
+/**
+ * Implements hook_ckeditor4to5upgrade_plugin_info_alter().
+ */
+function entity_embed_ckeditor4to5upgrade_plugin_info_alter(array &$plugin_definitions): void {
+  // Get the user set buttons and add them to the entity embed plugin definition
+  $buttons = [];
+  $embed_buttons = \Drupal::entityTypeManager()
+    ->getStorage('embed_button')
+    ->loadMultiple();
+  foreach ($embed_buttons as $embed_button) {
+    $buttons[] = $embed_button->id();
+  }
+
+  if ($buttons) {
+    $plugin_definitions['entity_embed']["cke4_buttons"] = $buttons;
+  }
+}
diff -ruN a/js/build/drupalentity.js b/js/build/drupalentity.js
--- a/js/build/drupalentity.js	1970-01-01 01:00:00.000000000 +0100
+++ b/js/build/drupalentity.js	2023-06-08 23:19:36.000000000 +0200
@@ -0,0 +1 @@
+!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.CKEditor5=e():(t.CKEditor5=t.CKEditor5||{},t.CKEditor5.drupalentity=e())}(self,(()=>(()=>{var t={"ckeditor5/src/core.js":(t,e,i)=>{t.exports=i("dll-reference CKEditor5.dll")("./src/core.js")},"ckeditor5/src/ui.js":(t,e,i)=>{t.exports=i("dll-reference CKEditor5.dll")("./src/ui.js")},"ckeditor5/src/widget.js":(t,e,i)=>{t.exports=i("dll-reference CKEditor5.dll")("./src/widget.js")},"dll-reference CKEditor5.dll":t=>{"use strict";t.exports=CKEditor5.dll}},e={};function i(r){var n=e[r];if(void 0!==n)return n.exports;var o=e[r]={exports:{}};return t[r](o,o.exports,i),o.exports}i.d=(t,e)=>{for(var r in e)i.o(e,r)&&!i.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var r={};return(()=>{"use strict";i.d(r,{default:()=>u});var t=i("ckeditor5/src/core.js"),e=i("ckeditor5/src/widget.js");class n extends t.Command{execute(t){const{model:e}=this.editor,i=this.editor.plugins.get("EntityEmbedEditing"),r=Object.entries(i.attrs).reduce(((t,[e,i])=>(t[i]=e,t)),{}),n=Object.keys(t).reduce(((e,i)=>(r[i]&&(e[r[i]]=t[i]),e)),{});e.change((t=>{e.insertContent(function(t,e){return t.createElement("drupalEntity",e)}(t,n))}))}refresh(){const t=this.editor.model,e=t.document.selection,i=t.schema.findAllowedParent(e.getFirstPosition(),"drupalEntity");this.isEnabled=null!==i}}class o extends t.Plugin{static get requires(){return[e.Widget]}init(){this.attrs={alt:"alt",title:"title",dataCaption:"data-caption",dataAlign:"data-align",drupalEntityLangCode:"data-langcode",drupalEntityEntityType:"data-entity-type",drupalEntityEntityUuid:"data-entity-uuid",drupalEntityEmbedButton:"data-embed-button",drupalEntityEmbedDisplay:"data-entity-embed-display",drupalEntityEmbedDisplaySettings:"data-entity-embed-display-settings"};const t=this.editor.config.get("entityEmbed");t&&(this.options=t,this.labelError=Drupal.t("Preview failed"),this.previewError=`\n      <p>${Drupal.t("An error occurred while trying to preview the embedded content. Please save your work and reload this page.")}<p>\n    `,this._defineSchema(),this._defineConverters(),this.editor.commands.add("insertEntityEmbed",new n(this.editor)))}_defineSchema(){this.editor.model.schema.register("drupalEntity",{isObject:!0,isContent:!0,isBlock:!0,allowWhere:"$block",allowAttributes:Object.keys(this.attrs)}),this.editor.editing.view.domConverter.blockElements.push("drupal-entity")}_defineConverters(){const{conversion:t}=this.editor;t.for("upcast").elementToElement({model:"drupalEntity",view:{name:"drupal-entity"}}),t.for("dataDowncast").elementToElement({model:"drupalEntity",view:{name:"drupal-entity"}}),t.for("editingDowncast").elementToElement({model:"drupalEntity",view:(t,{writer:i})=>{const r=i.createContainerElement("figure",{class:"drupal-entity"});return i.setCustomProperty("drupalEntity",!0,r),(0,e.toWidget)(r,i,{label:Drupal.t("Entity Embed widget")})}}).add((t=>(t.on("attribute:drupalEntityEntityUuid:drupalEntity",((t,e,i)=>{const r=i.writer,n=e.item,o=i.mapper.toViewElement(e.item);let a=this._getPreviewContainer(o.getChildren());if(a){if("ready"!==a.getAttribute("data-drupal-entity-preview"))return;r.setAttribute("data-drupal-entity-preview","loading",a)}else a=r.createRawElement("div",{"data-drupal-entity-preview":"loading"}),r.insert(r.createPositionAt(o,0),a);this._loadPreview(n).then((({label:t,preview:e})=>{a&&this.editor.editing.view.change((i=>{const r=i.createRawElement("div",{"data-drupal-entity-preview":"ready","aria-label":t},(t=>{t.innerHTML=e}));i.insert(i.createPositionBefore(a),r),i.remove(a)}))}))})),t))),Object.keys(this.attrs).forEach((e=>{const i={model:{key:e,name:"drupalEntity"},view:{name:"drupal-entity",key:this.attrs[e]}};t.for("dataDowncast").attributeToAttribute(i),t.for("upcast").attributeToAttribute(i)}))}async _loadPreview(t){const e={text:this._renderElement(t)},i=await fetch(Drupal.url("embed/preview/"+this.options.format+"?"+new URLSearchParams(e)),{headers:{"X-Drupal-EmbedPreview-CSRF-Token":this.options.previewCsrfToken}});if(i.ok){return{label:Drupal.t("Entity Embed widget"),preview:await i.text()}}return{label:this.labelError,preview:this.previewError}}_renderElement(t){const e=this.editor.model.change((e=>{const i=e.createDocumentFragment(),r=e.cloneElement(t,!1);return e.append(r,i),i}));return this.editor.data.stringify(e)}_getPreviewContainer(t){for(const e of t){if(e.hasAttribute("data-drupal-entity-preview"))return e;if(e.childCount){const t=this._getPreviewContainer(e.getChildren());if(t)return t}}return null}static get pluginName(){return"EntityEmbedEditing"}}var a=i("ckeditor5/src/ui.js");class d extends t.Plugin{static get requires(){return[e.WidgetToolbarRepository]}init(){const e=this.editor,i=e.plugins.get("EntityEmbedEditing"),r=e.config.get("entityEmbed"),{dialogSettings:n={}}=r;e.ui.componentFactory.add("entityEmbedEdit",(o=>{let d=new a.ButtonView(o);return d.set({label:e.t("Edit"),icon:t.icons.pencil,tooltip:!0}),this.listenTo(d,"execute",(t=>{let o=e.model.document.selection.getSelectedElement(),a=Drupal.url("entity-embed/dialog/"+r.format+"/"+o.getAttribute("drupalEntityEmbedButton")),d={};for(let[t,e]of o.getAttributes()){let r=i.attrs[t];r&&(d[r]=e)}this._openDialog(a,d,(({attributes:t})=>{e.execute("insertEntityEmbed",t),e.editing.view.focus()}),n)})),d}))}afterInit(){const{editor:t}=this;if(!t.plugins.has("WidgetToolbarRepository"))return;t.plugins.get("WidgetToolbarRepository").register("entityEmbed",{items:["entityEmbedEdit"],getRelatedElement(t){const i=t.getSelectedElement();return i&&(0,e.isWidget)(i)&&i.getCustomProperty("drupalEntity")?i:null}})}_openDialog(t,e,i,r){const n=r.dialogClass?r.dialogClass.split(" "):[];n.push("ui-dialog--narrow"),r.dialogClass=n.join(" "),r.autoResize=window.matchMedia("(min-width: 600px)").matches,r.width="auto";Drupal.ajax({dialog:r,dialogType:"modal",selector:".ckeditor5-dialog-loading-link",url:t,progress:{type:"fullscreen"},submit:{editor_object:e}}).execute(),Drupal.ckeditor5.saveCallback=i}static get pluginName(){return"EntityEmbedToolbar"}}class s extends t.Plugin{static get requires(){return["Widget"]}init(){const t=this.editor,e=t.commands.get("insertEntityEmbed"),i=t.config.get("entityEmbed");t.editing.view.document;if(!i)return;const{dialogSettings:r={}}=i,n=i.buttons;Object.keys(n).forEach((o=>{let d=Drupal.url("entity-embed/dialog/"+i.format+"/"+o);t.ui.componentFactory.add(o,(i=>{let s=n[o],l=new a.ButtonView(i),u=null;if(s.icon.endsWith("svg")){let t=new XMLHttpRequest;t.open("GET",s.icon,!1),t.send(null),u=t.response}return l.set({label:s.label,icon:u??'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="16px" height="16px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">  <image id="image0" width="16" height="16" x="0" y="0"\n    href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAAAJiS0dE\nAP+Hj8y/AAAAB3RJTUUH5gkNAywZrK+VpAAAAElJREFUKM9jYKAeuMrwHwUuhwizoCj6xfALzv6J\nzYRKTIOZCNmMaoUpQzKcvZnhFX5HWmIz4SrDDTj7LbUcSVABbkfeJ9kEcgEApvsllE2X4VkAAAAl\ndEVYdGRhdGU6Y3JlYXRlADIwMjItMDktMTNUMDE6NDQ6MjUrMDI6MDCMUacyAAAAJXRFWHRkYXRl\nOm1vZGlmeQAyMDIyLTA5LTEzVDAxOjQ0OjI1KzAyOjAw/QwfjgAAAABJRU5ErkJggg==" />\n</svg>\n',tooltip:!0}),l.bind("isOn","isEnabled").to(e,"value","isEnabled"),this.listenTo(l,"execute",(()=>Drupal.ckeditor5.openDialog(d,(({attributes:e})=>{t.execute("insertEntityEmbed",e)}),r))),l}))}))}static get pluginName(){return"EntityEmbedUI"}}class l extends t.Plugin{static get requires(){return[o,s,d]}static get pluginName(){return"EntityEmbed"}}const u={EntityEmbed:l}})(),r=r.default})()));
\ No newline at end of file
diff -ruN a/js/ckeditor5_plugins/drupalentity/entity.svg b/js/ckeditor5_plugins/drupalentity/entity.svg
--- a/js/ckeditor5_plugins/drupalentity/entity.svg	1970-01-01 01:00:00.000000000 +0100
+++ b/js/ckeditor5_plugins/drupalentity/entity.svg	2023-06-08 23:19:38.000000000 +0200
@@ -0,0 +1,9 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no"?>
+<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
+<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="16px" height="16px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">  <image id="image0" width="16" height="16" x="0" y="0"
+    href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAAAJiS0dE
+AP+Hj8y/AAAAB3RJTUUH5gkNAywZrK+VpAAAAElJREFUKM9jYKAeuMrwHwUuhwizoCj6xfALzv6J
+zYRKTIOZCNmMaoUpQzKcvZnhFX5HWmIz4SrDDTj7LbUcSVABbkfeJ9kEcgEApvsllE2X4VkAAAAl
+dEVYdGRhdGU6Y3JlYXRlADIwMjItMDktMTNUMDE6NDQ6MjUrMDI6MDCMUacyAAAAJXRFWHRkYXRl
+Om1vZGlmeQAyMDIyLTA5LTEzVDAxOjQ0OjI1KzAyOjAw/QwfjgAAAABJRU5ErkJggg==" />
+</svg>
diff -ruN a/js/ckeditor5_plugins/drupalentity/src/command.js b/js/ckeditor5_plugins/drupalentity/src/command.js
--- a/js/ckeditor5_plugins/drupalentity/src/command.js	1970-01-01 01:00:00.000000000 +0100
+++ b/js/ckeditor5_plugins/drupalentity/src/command.js	2023-06-08 23:19:41.000000000 +0200
@@ -0,0 +1,52 @@
+import {Command} from 'ckeditor5/src/core';
+
+export default class InsertEntityEmbedCommand extends Command {
+
+  execute(attributes) {
+    const { model } = this.editor;
+    const entityEmbedEditing = this.editor.plugins.get('EntityEmbedEditing');
+
+    // Create object that contains supported data-attributes in view data by
+    // flipping `EntityEmbedEditing.attrs` object (i.e. keys from object become
+    // values and values from object become keys).
+    const dataAttributeMapping = Object.entries(entityEmbedEditing.attrs).reduce(
+      (result, [key, value]) => {
+        result[value] = key;
+        return result;
+      },
+      {},
+    );
+
+    // \Drupal\entity_embed\Form\EntityEmbedDialog returns data in keyed by
+    // data-attributes used in view data. This converts data-attribute keys to
+    // keys used in model.
+    const modelAttributes = Object.keys(attributes).reduce(
+      (result, attribute) => {
+        if (dataAttributeMapping[attribute]) {
+          result[dataAttributeMapping[attribute]] = attributes[attribute];
+        }
+        return result;
+      },
+      {},
+    );
+
+    model.change((writer) => {
+      model.insertContent(createEntityEmbed(writer, modelAttributes));
+    });
+  }
+
+  refresh() {
+    const model = this.editor.model;
+    const selection = model.document.selection;
+    const allowedIn = model.schema.findAllowedParent(
+      selection.getFirstPosition(),
+      'drupalEntity',
+    );
+    this.isEnabled = allowedIn !== null;
+  };
+
+}
+
+function createEntityEmbed(writer, attributes) {
+  return writer.createElement('drupalEntity', attributes);
+}
diff -ruN a/js/ckeditor5_plugins/drupalentity/src/editing.js b/js/ckeditor5_plugins/drupalentity/src/editing.js
--- a/js/ckeditor5_plugins/drupalentity/src/editing.js	1970-01-01 01:00:00.000000000 +0100
+++ b/js/ckeditor5_plugins/drupalentity/src/editing.js	2023-06-08 23:19:41.000000000 +0200
@@ -0,0 +1,288 @@
+import { Plugin } from 'ckeditor5/src/core';
+import { Widget, toWidget } from 'ckeditor5/src/widget';
+import InsertEntityEmbedCommand from './command';
+
+export default class EntityEmbedEditing extends Plugin {
+
+  /**
+   * @inheritdoc
+   */
+  static get requires() {
+    return [Widget];
+  }
+
+  /**
+   * @inheritdoc
+   */
+  init() {
+    this.attrs = {
+      alt: 'alt',
+      title: 'title',
+      dataCaption: 'data-caption',
+      dataAlign: 'data-align',
+      drupalEntityLangCode: 'data-langcode',
+      drupalEntityEntityType: 'data-entity-type',
+      drupalEntityEntityUuid: 'data-entity-uuid',
+      drupalEntityEmbedButton: 'data-embed-button',
+      drupalEntityEmbedDisplay: 'data-entity-embed-display',
+      drupalEntityEmbedDisplaySettings: 'data-entity-embed-display-settings',
+    };
+    const options = this.editor.config.get('entityEmbed');
+    if (!options) {
+      return;
+    }
+    this.options = options;
+    this.labelError = Drupal.t('Preview failed');
+    this.previewError =`
+      <p>${Drupal.t(
+        'An error occurred while trying to preview the embedded content. Please save your work and reload this page.',
+      )}<p>
+    `;
+
+    this._defineSchema();
+    this._defineConverters();
+    this.editor.commands.add(
+      'insertEntityEmbed',
+      new InsertEntityEmbedCommand(this.editor),
+    );
+  }
+
+  /**
+   * Registers drupalEntity as a block element in the DOM.
+   *
+   * @private
+   */
+  _defineSchema() {
+    const schema = this.editor.model.schema;
+
+    schema.register('drupalEntity', {
+      isObject: true,
+      isContent: true,
+      isBlock: true,
+      allowWhere: '$block',
+      allowAttributes: Object.keys(this.attrs),
+    });
+    this.editor.editing.view.domConverter.blockElements.push('drupal-entity');
+  }
+
+  /**
+   * Defines handling of drupalEntity elements.
+   *
+   * @private
+   */
+  _defineConverters() {
+    const {conversion} = this.editor;
+
+    conversion
+      .for('upcast')
+      .elementToElement({
+        model: 'drupalEntity',
+        view: {
+          name: 'drupal-entity',
+        },
+      });
+
+    conversion
+      .for('dataDowncast')
+      .elementToElement({
+        model: 'drupalEntity',
+        view: {
+          name: 'drupal-entity',
+        },
+      });
+
+    // Convert the <drupalEntity> model into an editable <drupal-entity> widget.
+    conversion
+      .for('editingDowncast')
+      .elementToElement({
+        model: 'drupalEntity',
+        view: (modelElement, { writer }) => {
+          const container = writer.createContainerElement('figure', {
+            class: 'drupal-entity',
+          });
+          writer.setCustomProperty('drupalEntity', true, container);
+
+          return toWidget(container, writer, {
+            label: Drupal.t('Entity Embed widget'),
+          })
+        },
+      })
+      .add((dispatcher) => {
+        const converter = (event, data, conversionApi) => {
+          const viewWriter = conversionApi.writer;
+          const modelElement = data.item;
+          const container = conversionApi.mapper.toViewElement(data.item);
+
+          let drupalEntity = this._getPreviewContainer(container.getChildren());
+          // Use existing container if it exists, create on if it does not.
+          if (drupalEntity) {
+            // Stop processing if a preview is already loading.
+            if (drupalEntity.getAttribute('data-drupal-entity-preview') !== 'ready') {
+              return;
+            }
+            // Preview was ready meaning that a new preview can be loaded.
+            // Change the attribute to loading to prepare for the loading of
+            // the updated preview. Preview is kept intact so that it remains
+            // interactable in the UI until the new preview has been rendered.
+            viewWriter.setAttribute(
+              'data-drupal-entity-preview',
+              'loading',
+              drupalEntity,
+            );
+          }
+          else {
+            drupalEntity = viewWriter.createRawElement('div', {
+              'data-drupal-entity-preview': 'loading',
+            });
+            viewWriter.insert(viewWriter.createPositionAt(container, 0), drupalEntity);
+          }
+
+          this._loadPreview(modelElement).then(({ label, preview }) => {
+            if (!drupalEntity) {
+              // Nothing to do if associated preview wrapped no longer exist.
+              return;
+            }
+            // CKEditor 5 doesn't support async view conversion. Therefore, once
+            // the promise is fulfilled, the editing view needs to be modified
+            // manually.
+            this.editor.editing.view.change((writer) => {
+              const drupalEntityPreview = writer.createRawElement(
+                'div',
+                {'data-drupal-entity-preview': 'ready', 'aria-label': label},
+                (domElement) => {
+                  domElement.innerHTML = preview;
+                },
+              );
+              // Insert the new preview before the previous preview element to
+              // ensure that the location remains same even if it is wrapped
+              // with another element.
+              writer.insert(writer.createPositionBefore(drupalEntity), drupalEntityPreview);
+              writer.remove(drupalEntity);
+            });
+          });
+        }
+
+        dispatcher.on('attribute:drupalEntityEntityUuid:drupalEntity', converter);
+
+        return dispatcher;
+      });
+
+    // Set attributeToAttribute conversion for all supported attributes.
+    Object.keys(this.attrs).forEach((modelKey) => {
+      const attributeMapping = {
+        model: {
+          key: modelKey,
+          name: 'drupalEntity',
+        },
+        view: {
+          name: 'drupal-entity',
+          key: this.attrs[modelKey],
+        },
+      };
+      // Attributes should be rendered only in dataDowncast to avoid having
+      // unfiltered data-attributes on the Drupal Entity widget.
+      conversion.for('dataDowncast').attributeToAttribute(attributeMapping);
+      conversion.for('upcast').attributeToAttribute(attributeMapping);
+    });
+  }
+
+  /**
+   * Loads the preview.
+   *
+   * @param modelElement
+   *   The model element which preview should be loaded.
+   * @returns {Promise<{preview: string, label: *}|{preview: *, label: string}>}
+   *   A promise that returns an object.
+   *
+   * @private
+   *
+   * @see DrupalMediaEditing::_fetchPreview().
+   */
+  async _loadPreview(modelElement) {
+    const query = {
+      text: this._renderElement(modelElement),
+    };
+
+    const response = await fetch(
+      Drupal.url('embed/preview/' + this.options.format + '?' + new URLSearchParams(query)),
+      {
+        headers: {
+          'X-Drupal-EmbedPreview-CSRF-Token':
+          this.options.previewCsrfToken,
+        },
+      },
+    );
+
+    if (response.ok) {
+      const label = Drupal.t('Entity Embed widget');
+      const preview = await response.text();
+      return { label, preview };
+    }
+
+    return { label: this.labelError, preview: this.previewError };
+  }
+
+  /**
+   * Renders the model element.
+   *
+   * @param modelElement
+   *   The drupalMedia model element to be converted.
+   * @returns {*}
+   *   The model element converted into HTML.
+   *
+   * @private
+   */
+  _renderElement(modelElement) {
+    // Create model document fragment which contains the model element so that
+    // it can be stringified using the dataDowncast.
+    const modelDocumentFragment = this.editor.model.change((writer) => {
+      const modelDocumentFragment = writer.createDocumentFragment();
+      // Create shallow clone of the model element to ensure that the original
+      // model element remains untouched and that the caption is not rendered
+      // into the preview.
+      const clonedModelElement = writer.cloneElement(modelElement, false);
+      writer.append(clonedModelElement, modelDocumentFragment);
+
+      return modelDocumentFragment;
+    });
+
+    return this.editor.data.stringify(modelDocumentFragment);
+  }
+
+  /**
+   * Gets the preview container element.
+   *
+   * @param children
+   *   The child elements.
+   * @returns {null|*}
+   *    The preview child element if available.
+   *
+   * @private
+   */
+  _getPreviewContainer(children) {
+    for (const child of children) {
+      if (child.hasAttribute('data-drupal-entity-preview')) {
+        return child;
+      }
+
+      if (child.childCount) {
+        const recursive = this._getPreviewContainer(child.getChildren());
+        // Return only if preview container was found within this element's
+        // children.
+        if (recursive) {
+          return recursive;
+        }
+      }
+    }
+
+    return null;
+  }
+
+  /**
+   * @inheritdoc
+   */
+  static get pluginName() {
+    return 'EntityEmbedEditing';
+  }
+
+}
diff -ruN a/js/ckeditor5_plugins/drupalentity/src/entityembed.js b/js/ckeditor5_plugins/drupalentity/src/entityembed.js
--- a/js/ckeditor5_plugins/drupalentity/src/entityembed.js	1970-01-01 01:00:00.000000000 +0100
+++ b/js/ckeditor5_plugins/drupalentity/src/entityembed.js	2023-06-08 23:19:40.000000000 +0200
@@ -0,0 +1,19 @@
+import EntityEmbedEditing from './editing';
+import EntityEmbedToolbar from './toolbar';
+import EntityEmbedUI from './ui';
+import { Plugin } from 'ckeditor5/src/core';
+
+export default class EntityEmbed extends Plugin {
+
+  static get requires() {
+    return [EntityEmbedEditing, EntityEmbedUI, EntityEmbedToolbar];
+  }
+
+  /**
+   * @inheritdoc
+   */
+  static get pluginName() {
+    return 'EntityEmbed';
+  }
+
+}
diff -ruN a/js/ckeditor5_plugins/drupalentity/src/index.js b/js/ckeditor5_plugins/drupalentity/src/index.js
--- a/js/ckeditor5_plugins/drupalentity/src/index.js	1970-01-01 01:00:00.000000000 +0100
+++ b/js/ckeditor5_plugins/drupalentity/src/index.js	2023-06-08 23:19:40.000000000 +0200
@@ -0,0 +1,9 @@
+/**
+ * @module entity-embed
+ */
+
+import EntityEmbed from './entityembed';
+
+export default {
+  EntityEmbed,
+};
diff -ruN a/js/ckeditor5_plugins/drupalentity/src/toolbar.js b/js/ckeditor5_plugins/drupalentity/src/toolbar.js
--- a/js/ckeditor5_plugins/drupalentity/src/toolbar.js	1970-01-01 01:00:00.000000000 +0100
+++ b/js/ckeditor5_plugins/drupalentity/src/toolbar.js	2023-06-08 23:19:39.000000000 +0200
@@ -0,0 +1,135 @@
+import { Plugin, icons } from 'ckeditor5/src/core';
+import { isWidget, WidgetToolbarRepository } from 'ckeditor5/src/widget';
+import { ButtonView } from "ckeditor5/src/ui";
+
+export default class EntityEmbedToolbar extends Plugin {
+
+  /**
+   * @inheritdoc
+   */
+  static get requires() {
+    return [WidgetToolbarRepository];
+  }
+
+  /**
+   * @inheritdoc
+   */
+  init() {
+    const editor = this.editor;
+    const entityEmbedEditing = editor.plugins.get('EntityEmbedEditing');
+    const options = editor.config.get('entityEmbed');
+    const { dialogSettings = {} } = options;
+
+    editor.ui.componentFactory.add('entityEmbedEdit', (locale) => {
+      let buttonView = new ButtonView(locale);
+
+      buttonView.set({
+        label: editor.t('Edit'),
+        icon: icons.pencil,
+        tooltip: true,
+      })
+
+      this.listenTo(buttonView, 'execute', (eventInfo) => {
+        let element = editor.model.document.selection.getSelectedElement();
+        let libraryURL = Drupal.url('entity-embed/dialog/' + options.format + '/' + element.getAttribute('drupalEntityEmbedButton'));
+
+        let existingValues = {};
+
+        for (let [key, value] of element.getAttributes()) {
+          let attribute = entityEmbedEditing.attrs[key]
+          if (attribute) {
+            existingValues[attribute] = value
+          }
+        }
+
+        // Open a dialog to select entity to embed.
+        this._openDialog(
+          libraryURL,
+          existingValues,
+          ({ attributes }) => {
+            editor.execute('insertEntityEmbed', attributes);
+            editor.editing.view.focus();
+          },
+          dialogSettings,
+        )
+      });
+
+      return buttonView;
+    })
+  }
+
+  /**
+   * @inheritdoc
+   */
+  afterInit() {
+    const { editor } = this
+    if (!editor.plugins.has('WidgetToolbarRepository')) {
+      return;
+    }
+    const widgetToolbarRepository = editor.plugins.get('WidgetToolbarRepository')
+
+    widgetToolbarRepository.register('entityEmbed', {
+      items: ['entityEmbedEdit'],
+      getRelatedElement(selection) {
+        const viewElement = selection.getSelectedElement()
+        if (!viewElement) {
+          return null
+        }
+        if (!isWidget(viewElement)) {
+          return null
+        }
+        if (!viewElement.getCustomProperty('drupalEntity')) {
+          return null
+        }
+
+        return viewElement
+      },
+    })
+  }
+
+  /**
+   * @param {string} url
+   *   The URL that contains the contents of the dialog.
+   * @param {object} existingValues
+   *   Existing values that will be sent via POST to the url for the dialog
+   *   contents.
+   * @param {function} saveCallback
+   *   A function to be called upon saving the dialog.
+   * @param {object} dialogSettings
+   *   An object containing settings to be passed to the jQuery UI.
+   */
+  _openDialog(url, existingValues, saveCallback, dialogSettings) {
+    // Add a consistent dialog class.
+    const classes = dialogSettings.dialogClass
+      ? dialogSettings.dialogClass.split(' ')
+      : [];
+    classes.push('ui-dialog--narrow');
+    dialogSettings.dialogClass = classes.join(' ');
+    dialogSettings.autoResize =
+      window.matchMedia('(min-width: 600px)').matches;
+    dialogSettings.width = 'auto';
+
+    const ckeditorAjaxDialog = Drupal.ajax({
+      dialog: dialogSettings,
+      dialogType: 'modal',
+      selector: '.ckeditor5-dialog-loading-link',
+      url,
+      progress: { type: 'fullscreen' },
+      submit: {
+        editor_object: existingValues,
+      },
+    });
+    ckeditorAjaxDialog.execute();
+
+    // Store the save callback to be executed when this dialog is closed.
+    Drupal.ckeditor5.saveCallback = saveCallback;
+  }
+
+  /**
+   * @inheritdoc
+   */
+  static get pluginName() {
+    return 'EntityEmbedToolbar';
+  }
+
+}
diff -ruN a/js/ckeditor5_plugins/drupalentity/src/ui.js b/js/ckeditor5_plugins/drupalentity/src/ui.js
--- a/js/ckeditor5_plugins/drupalentity/src/ui.js	1970-01-01 01:00:00.000000000 +0100
+++ b/js/ckeditor5_plugins/drupalentity/src/ui.js	2023-06-08 23:19:39.000000000 +0200
@@ -0,0 +1,79 @@
+/**
+ * @file Registers the entity embed button(s) to the CKEditor instance(s) and binds functionality to it/them.
+ */
+
+import { Plugin } from 'ckeditor5/src/core';
+import { ButtonView } from 'ckeditor5/src/ui';
+import defaultIcon from '../entity.svg';
+
+export default class EntityEmbedUI extends Plugin {
+
+  /**
+   * @inheritdoc
+   */
+  static get requires() {
+    return ['Widget'];
+  }
+
+  /**
+   * @inheritdoc
+   */
+  init() {
+    const editor = this.editor;
+    const command = editor.commands.get('insertEntityEmbed');
+    const options = editor.config.get('entityEmbed');
+    const viewDocument = editor.editing.view.document;
+    if (!options) {
+      return;
+    }
+    const { dialogSettings = {} } = options;
+    const embed_buttons = options.buttons;
+
+    // Register each embed button to the toolbar based on configuration.
+    Object.keys(embed_buttons).forEach(id => {
+      let libraryURL = Drupal.url('entity-embed/dialog/' + options.format + '/' + id);
+      // Add each button to the toolbar.
+      editor.ui.componentFactory.add(id, (locale) => {
+        let button = embed_buttons[id];
+        let buttonView = new ButtonView(locale);
+        // Set the icon to the SVG from config, or set it to the default icon.
+        // If the uploaded icon is an SVG, load it or use the default icon otherwise.
+        let icon = null;
+        if (button.icon.endsWith('svg')) {
+          let XMLrequest = new XMLHttpRequest();
+          XMLrequest.open("GET", button.icon, false);
+          XMLrequest.send(null);
+          icon = XMLrequest.response;
+        }
+
+        buttonView.set({
+          label: button.label,
+          icon: icon ?? defaultIcon,
+          tooltip: true,
+        });
+        buttonView.bind('isOn', 'isEnabled').to(command, 'value', 'isEnabled');
+
+        this.listenTo(buttonView, 'execute', () =>
+          // Open a dialog to select entity to embed.
+          Drupal.ckeditor5.openDialog(
+            libraryURL,
+            ({ attributes }) => {
+              editor.execute('insertEntityEmbed', attributes);
+            },
+            dialogSettings,
+          ),
+        );
+
+        return buttonView;
+      })
+    });
+  }
+
+  /**
+   * @inheritdoc
+   */
+  static get pluginName() {
+    return 'EntityEmbedUI';
+  }
+
+}
diff -ruN a/js/entity_embed.set_dynamic_icons.js b/js/entity_embed.set_dynamic_icons.js
--- a/js/entity_embed.set_dynamic_icons.js	1970-01-01 01:00:00.000000000 +0100
+++ b/js/entity_embed.set_dynamic_icons.js	2023-06-08 23:19:34.000000000 +0200
@@ -0,0 +1,18 @@
+/* This script is responsible for setting the correct image(s) on the admin
+ * toolbar, as we cannot build the JS for it because we do not know how
+ * many entity embed buttons are there in the system. The number of buttons
+ * created are based on the number of embed buttons.
+ */
+(function ($, Drupal, drupalSettings, once) {
+  Drupal.behaviors.entityEmbedSetDynamicIcons = {
+    attach: function (context) {
+      // Get the available Embed Buttons from Drupal.
+      Object.values(drupalSettings.embedButtons || {}).forEach(function (button) {
+        // Iterate through the embed buttons and set the corresponding background image.
+        let selector = '.ckeditor5-toolbar-button-' + button.id;
+        let iconUrl = button.icon.endsWith('svg') ? button.icon : '/' + drupalSettings.modulePath + '/js/ckeditor5_plugins/drupalentity/entity.svg';
+        $(once('entityEmbedSetDynamicIcons', selector, context)).css('background-image', 'url(' + iconUrl + ')');
+      });
+    },
+  }
+})(jQuery, Drupal, drupalSettings, once);
diff -ruN a/package.json b/package.json
--- a/package.json	1970-01-01 01:00:00.000000000 +0100
+++ b/package.json	2023-06-08 23:18:41.000000000 +0200
@@ -0,0 +1,19 @@
+{
+  "name": "drupal-entity-embed",
+  "version": "1.0.0",
+  "description": "Drupal Entity Embed CKEditor 5 integration",
+  "author": "",
+  "license": "GPL-2.0-or-later",
+  "scripts": {
+    "watch": "webpack --mode development --watch",
+    "build": "webpack"
+  },
+  "devDependencies": {
+    "@ckeditor/ckeditor5-dev-utils": "^30.0.0",
+    "ckeditor5": "~34.1.0",
+    "raw-loader": "^4.0.2",
+    "terser-webpack-plugin": "^5.2.0",
+    "webpack": "^5.51.1",
+    "webpack-cli": "^4.4.0"
+  }
+}
diff -ruN a/src/Form/EntityEmbedDialog.php b/src/Form/EntityEmbedDialog.php
--- a/src/Form/EntityEmbedDialog.php	2022-10-20 16:16:12.000000000 +0200
+++ b/src/Form/EntityEmbedDialog.php	2023-06-08 23:19:29.000000000 +0200
@@ -13,6 +13,7 @@
 use Drupal\Core\Entity\FieldableEntityInterface;
 use Drupal\Core\Entity\TranslatableInterface;
 use Drupal\Core\Extension\ModuleHandlerInterface;
+use Drupal\Core\File\FileUrlGeneratorInterface;
 use Drupal\Core\Form\FormBase;
 use Drupal\Core\Form\FormBuilderInterface;
 use Drupal\Core\Form\FormStateInterface;
@@ -81,6 +82,13 @@
   protected $moduleHandler;
 
   /**
+   * The file URL generator.
+   *
+   * @var \Drupal\Core\File\FileUrlGeneratorInterface
+   */
+  protected $fileUrlGenerator;
+
+  /**
    * The entity browser settings from the entity embed button.
    *
    * @var array
@@ -102,14 +110,17 @@
    *   The entity field manager.
    * @param \Drupal\Core\Extension\ModuleHandlerInterface $module_handler
    *   The module handler.
+   * @param \Drupal\Core\File\FileUrlGeneratorInterface
+   *   The file URL generator.
    */
-  public function __construct(EntityEmbedDisplayManager $entity_embed_display_manager, FormBuilderInterface $form_builder, EntityTypeManagerInterface $entity_type_manager, EventDispatcherInterface $event_dispatcher, EntityFieldManagerInterface $entity_field_manager, ModuleHandlerInterface $module_handler) {
+  public function __construct(EntityEmbedDisplayManager $entity_embed_display_manager, FormBuilderInterface $form_builder, EntityTypeManagerInterface $entity_type_manager, EventDispatcherInterface $event_dispatcher, EntityFieldManagerInterface $entity_field_manager, ModuleHandlerInterface $module_handler, FileUrlGeneratorInterface $file_url_generator) {
     $this->entityEmbedDisplayManager = $entity_embed_display_manager;
     $this->formBuilder = $form_builder;
     $this->entityTypeManager = $entity_type_manager;
     $this->eventDispatcher = $event_dispatcher;
     $this->entityFieldManager = $entity_field_manager;
     $this->moduleHandler = $module_handler;
+    $this->fileUrlGenerator = $file_url_generator;
   }
 
   /**
@@ -122,7 +133,8 @@
       $container->get('entity_type.manager'),
       $container->get('event_dispatcher'),
       $container->get('entity_field.manager'),
-      $container->get('module_handler')
+      $container->get('module_handler'),
+      $container->get('file_url_generator')
     );
   }
 
@@ -415,7 +427,7 @@
         $entity_label = $entity->toLink($entity->label(), 'canonical', $options)->toString();
       }
       elseif ($entity->getEntityTypeId() == 'file') {
-        $entity_label = '<a href="' . file_create_url($entity->getFileUri()) . '" target="_blank">' . $entity->label() . '</a>';
+          $entity_label = '<a href="' . $this->fileUrlGenerator->generateAbsoluteString($entity->getFileUri()) . '" target="_blank">' . $entity->label() . '</a>';
       }
       else {
         $entity_label = '<a href="' . $entity->toUrl()->toString() . '" target="_blank">' . $entity->label() . '</a>';
diff -ruN a/src/Plugin/CKEditor4To5Upgrade/EntityEmbed.php b/src/Plugin/CKEditor4To5Upgrade/EntityEmbed.php
--- a/src/Plugin/CKEditor4To5Upgrade/EntityEmbed.php	1970-01-01 01:00:00.000000000 +0100
+++ b/src/Plugin/CKEditor4To5Upgrade/EntityEmbed.php	2023-06-08 23:19:21.000000000 +0200
@@ -0,0 +1,62 @@
+<?php
+
+namespace Drupal\entity_embed\Plugin\CKEditor4To5Upgrade;
+
+use Drupal\ckeditor5\HTMLRestrictions;
+use Drupal\ckeditor5\Plugin\CKEditor4To5UpgradePluginInterface;
+use Drupal\Core\Plugin\PluginBase;
+use Drupal\filter\FilterFormatInterface;
+
+/**
+ * Provides the CKEditor 4 to 5 upgrade path for entity embed buttons.
+ *
+ * @CKEditor4To5Upgrade(
+ *   id = "entity_embed",
+ *   cke4_buttons = {
+ *   },
+ *   cke4_plugin_settings = {
+ *   },
+ *   cke5_plugin_elements_subset_configuration = {
+ *   }
+ * )
+ *
+ * @internal
+ *   Plugin classes are internal.
+ */
+class EntityEmbed extends PluginBase implements CKEditor4To5UpgradePluginInterface {
+
+  /**
+   * {@inheritdoc}
+   */
+  public function mapCKEditor4ToolbarButtonToCKEditor5ToolbarItem(string $cke4_button, HTMLRestrictions $text_format_html_restrictions): ?array {
+    $buttons = [];
+
+    $embed_buttons = \Drupal::entityTypeManager()
+      ->getStorage('embed_button')
+      ->loadMultiple();
+    foreach ($embed_buttons as $embed_button) {
+      $buttons[] = $embed_button->id();
+    }
+    foreach ($buttons as $button) {
+      if ($cke4_button == $button) {
+        return [$button];
+      }
+    }
+
+    throw new \OutOfBoundsException();
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public function mapCKEditor4SettingsToCKEditor5Configuration(string $cke4_plugin_id, array $cke4_plugin_settings): ?array {
+    throw new \OutOfBoundsException();
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public function computeCKEditor5PluginSubsetConfiguration(string $cke5_plugin_id, FilterFormatInterface $text_format): ?array {
+    throw new \OutOfBoundsException();
+  }
+}
diff -ruN a/src/Plugin/CKEditor5Plugin/DrupalEntity.php b/src/Plugin/CKEditor5Plugin/DrupalEntity.php
--- a/src/Plugin/CKEditor5Plugin/DrupalEntity.php	1970-01-01 01:00:00.000000000 +0100
+++ b/src/Plugin/CKEditor5Plugin/DrupalEntity.php	2023-06-08 23:19:20.000000000 +0200
@@ -0,0 +1,129 @@
+<?php
+
+declare(strict_types = 1);
+
+namespace Drupal\entity_embed\Plugin\CKEditor5Plugin;
+
+use Drupal\ckeditor5\Plugin\CKEditor5PluginDefault;
+use Drupal\ckeditor5\Plugin\CKEditor5PluginDefinition;
+use Drupal\Component\Utility\Html;
+use Drupal\Core\Access\CsrfTokenGenerator;
+use Drupal\Core\Entity\EntityTypeManagerInterface;
+use Drupal\Core\Plugin\ContainerFactoryPluginInterface;
+use Drupal\editor\EditorInterface;
+use Symfony\Component\DependencyInjection\ContainerInterface;
+
+/**
+ * @CKEditor5Plugin(
+ *   id = "entity_embed_drupalentity",
+ *   ckeditor5 = @CKEditor5AspectsOfCKEditor5Plugin(
+ *     plugins = {"drupalentity.EntityEmbed"},
+ *     config = {},
+ *   ),
+ *   drupal = @DrupalAspectsOfCKEditor5Plugin(
+ *     deriver = "Drupal\entity_embed\Plugin\CKEditor5Plugin\DrupalEntityDeriver",
+ *     library = "entity_embed/entity_embed",
+ *     admin_library = "entity_embed/admin.entity_embed",
+ *     elements = {
+ *       "<drupal-entity>",
+ *       "<drupal-entity alt data-align data-caption data-entity-embed-display data-entity-embed-display-settings data-entity-uuid>",
+ *     },
+ *     conditions = {
+ *       "filter" = "entity_embed",
+ *     },
+ *   )
+ * )
+ */
+class DrupalEntity extends CKEditor5PluginDefault implements ContainerFactoryPluginInterface {
+
+  /**
+   * The CSRF Token generator.
+   *
+   * @var \Drupal\Core\Access\CsrfTokenGenerator
+   */
+  protected $csrfTokenGenerator;
+
+  /**
+   * The entity type manager.
+   *
+   * @var \Drupal\Core\Entity\EntityTypeManagerInterface
+   */
+  protected $entityTypeManager;
+
+  /**
+   * DrupalEntity constructor.
+   *
+   * @param array $configuration
+   *   A configuration array containing information about the plugin instance.
+   * @param string $plugin_id
+   *   The plugin_id for the plugin instance.
+   * @param \Drupal\ckeditor5\Plugin\CKEditor5PluginDefinition $plugin_definition
+   *   The plugin implementation definition.
+   * @param \Drupal\Core\Access\CsrfTokenGenerator $csrf_token_generator
+   *   The CSRF Token generator service.
+   * @param \Drupal\Core\Entity\EntityTypeManagerInterface $entity_type_manager
+   *   The Entity Type Manager service.
+   */
+  public function __construct(
+    array $configuration,
+    string $plugin_id,
+    CKEditor5PluginDefinition $plugin_definition,
+    CsrfTokenGenerator $csrf_token_generator,
+    EntityTypeManagerInterface $entity_type_manager
+  ) {
+    parent::__construct($configuration, $plugin_id, $plugin_definition);
+    $this->csrfTokenGenerator = $csrf_token_generator;
+    $this->entityTypeManager = $entity_type_manager;
+  }
+
+  /**
+   * {@inheritDoc}
+   */
+  public static function create(ContainerInterface $container, array $configuration, $plugin_id, $plugin_definition) {
+    return new static(
+      $configuration,
+      $plugin_id,
+      $plugin_definition,
+      $container->get('csrf_token'),
+      $container->get('entity_type.manager')
+    );
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public function getDynamicPluginConfig(array $static_plugin_config, EditorInterface $editor): array {
+    // Register embed buttons as individual buttons on admin pages.
+    $dynamic_plugin_config = $static_plugin_config;
+    $embed_buttons = $this
+      ->entityTypeManager
+      ->getStorage('embed_button')
+      ->loadMultiple();
+    $buttons = [];
+    /** @var \Drupal\embed\EmbedButtonInterface $embed_button */
+    foreach ($embed_buttons as $embed_button) {
+      $id = $embed_button->id();
+      $label = Html::escape($embed_button->label());
+      $buttons[$id] = [
+        'id' => $id,
+        'name' => $label,
+        'label' => $label,
+        'icon' => $embed_button->getIconUrl(),
+      ];
+    }
+    // Add configured embed buttons and pass it to the UI.
+    $dynamic_plugin_config['entityEmbed'] = [
+      'buttons' => $buttons,
+      'format' => $editor->getFilterFormat()->id(),
+      'dialogSettings' => [
+        'dialogClass' => 'entity-select-dialog',
+        'height' => 'auto',
+        'width' => 'auto',
+      ],
+      'previewCsrfToken' => $this->csrfTokenGenerator->get('X-Drupal-EmbedPreview-CSRF-Token'),
+    ];
+
+    return $dynamic_plugin_config;
+  }
+
+}
diff -ruN a/src/Plugin/CKEditor5Plugin/DrupalEntityDeriver.php b/src/Plugin/CKEditor5Plugin/DrupalEntityDeriver.php
--- a/src/Plugin/CKEditor5Plugin/DrupalEntityDeriver.php	1970-01-01 01:00:00.000000000 +0100
+++ b/src/Plugin/CKEditor5Plugin/DrupalEntityDeriver.php	2023-06-08 23:19:21.000000000 +0200
@@ -0,0 +1,74 @@
+<?php
+
+declare(strict_types = 1);
+
+namespace Drupal\entity_embed\Plugin\CKEditor5Plugin;
+
+use Drupal\ckeditor5\Plugin\CKEditor5PluginDefinition;
+use Drupal\Component\Plugin\Derivative\DeriverBase;
+use Drupal\Component\Utility\Html;
+use Drupal\Core\Entity\EntityTypeManagerInterface;
+use Drupal\Core\Plugin\Discovery\ContainerDeriverInterface;
+use Drupal\Core\StringTranslation\StringTranslationTrait;
+use Symfony\Component\DependencyInjection\ContainerInterface;
+
+class DrupalEntityDeriver extends DeriverBase implements ContainerDeriverInterface {
+
+  use StringTranslationTrait;
+
+  /**
+   * The entity type manager.
+   *
+   * @var \Drupal\Core\Entity\EntityTypeManagerInterface
+   */
+  protected $embedButtonStorage;
+
+  /**
+   * Constructs a new DrupalEntityDeriver object.
+   *
+   * @param \Drupal\Core\Entity\EntityTypeManagerInterface $entity_type_manager
+   *   The entity type manager.
+   *
+   * @throws \Drupal\Component\Plugin\Exception\InvalidPluginDefinitionException
+   * @throws \Drupal\Component\Plugin\Exception\PluginNotFoundException
+   */
+  public function __construct(EntityTypeManagerInterface $entity_type_manager) {
+    $this->embedButtonStorage = $entity_type_manager->getStorage('embed_button');
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public static function create(ContainerInterface $container, $base_plugin_id) {
+    return new static(
+      $container->get('entity_type.manager')
+    );
+  }
+
+  /**
+   * {@inheritdoc}
+   */
+  public function getDerivativeDefinitions($base_plugin_definition) {
+    assert($base_plugin_definition instanceof CKEditor5PluginDefinition);
+    /** @var \Drupal\embed\EmbedButtonInterface $embed_button */
+    foreach ($this->embedButtonStorage->loadMultiple() as $embed_button) {
+      $embed_button_id = $embed_button->id();
+      $embed_button_label = Html::escape($embed_button->label());
+      $plugin_id = "entity_embed_{$embed_button_id}";
+      $definition = $base_plugin_definition->toArray();
+      $definition['id'] .= $embed_button_id;
+      $definition['drupal']['label'] = $this->t('Entity Embed - @label', ['@label' => $embed_button_label])->render();
+      $definition['drupal']['toolbar_items'] = [
+        $embed_button_id => [
+          'label' => $embed_button_label,
+        ],
+      ];
+      $definition['drupal']['elements'][] = '<drupal-entity data-embed-button="' . $embed_button_id . '">';
+      $definition['drupal']['elements'][] = '<drupal-entity data-entity-type="' . $embed_button->getTypeSetting('entity_type') . '">';
+      $this->derivatives[$plugin_id] = new CKEditor5PluginDefinition($definition);
+    }
+
+    return $this->derivatives;
+  }
+
+}
diff -ruN a/src/Plugin/EmbedType/Entity.php b/src/Plugin/EmbedType/Entity.php
--- a/src/Plugin/EmbedType/Entity.php	2022-10-20 16:16:12.000000000 +0200
+++ b/src/Plugin/EmbedType/Entity.php	2023-06-08 23:19:19.000000000 +0200
@@ -6,6 +6,7 @@
 use Drupal\Core\Entity\EntityTypeInterface;
 use Drupal\Core\Entity\EntityTypeManagerInterface;
 use Drupal\Core\Entity\EntityTypeRepositoryInterface;
+use Drupal\Core\File\FileUrlGeneratorInterface;
 use Drupal\Core\Form\FormStateInterface;
 use Drupal\Core\Plugin\ContainerFactoryPluginInterface;
 use Drupal\Core\Plugin\PluginDependencyTrait;
@@ -54,6 +55,13 @@
   protected $displayPluginManager;
 
   /**
+   * The file URL generator.
+   *
+   * @var \Drupal\Core\File\FileUrlGeneratorInterface
+   */
+  protected $fileUrlGenerator;
+
+  /**
    * {@inheritdoc}
    *
    * @param array $configuration
@@ -70,13 +78,16 @@
    *   The entity type bundle info service.
    * @param \Drupal\entity_embed\EntityEmbedDisplay\EntityEmbedDisplayManager $display_plugin_manager
    *   The plugin manager.
+   * @param \Drupal\Core\File\FileUrlGeneratorInterface
+   *   The file URL generator.
    */
-  public function __construct(array $configuration, $plugin_id, $plugin_definition, EntityTypeManagerInterface $entity_type_manager, EntityTypeRepositoryInterface $entity_type_repository, EntityTypeBundleInfoInterface $bundle_info, EntityEmbedDisplayManager $display_plugin_manager) {
+  public function __construct(array $configuration, $plugin_id, $plugin_definition, EntityTypeManagerInterface $entity_type_manager, EntityTypeRepositoryInterface $entity_type_repository, EntityTypeBundleInfoInterface $bundle_info, EntityEmbedDisplayManager $display_plugin_manager, FileUrlGeneratorInterface $file_url_generator) {
     parent::__construct($configuration, $plugin_id, $plugin_definition);
     $this->entityTypeManager = $entity_type_manager;
     $this->entityTypeRepository = $entity_type_repository;
     $this->entityTypeBundleInfo = $bundle_info;
     $this->displayPluginManager = $display_plugin_manager;
+    $this->fileUrlGenerator = $file_url_generator;
   }
 
   /**
@@ -90,7 +101,8 @@
       $container->get('entity_type.manager'),
       $container->get('entity_type.repository'),
       $container->get('entity_type.bundle.info'),
-      $container->get('plugin.manager.entity_embed.display')
+      $container->get('plugin.manager.entity_embed.display'),
+      $container->get('file_url_generator')
     );
   }
 
@@ -273,7 +285,7 @@
    * {@inheritdoc}
    */
   public function getDefaultIconUrl() {
-    return file_create_url(drupal_get_path('module', 'entity_embed') . '/js/plugins/drupalentity/entity.png');
+    return $this->fileUrlGenerator->generateAbsoluteString(\Drupal::service('extension.list.module')->getPath('entity_embed') . '/js/plugins/drupalentity/entity.png');
   }
 
   /**
diff -ruN a/src/Plugin/Filter/EntityEmbedFilter.php b/src/Plugin/Filter/EntityEmbedFilter.php
--- a/src/Plugin/Filter/EntityEmbedFilter.php	2022-10-20 16:16:12.000000000 +0200
+++ b/src/Plugin/Filter/EntityEmbedFilter.php	2023-06-08 23:19:25.000000000 +0200
@@ -5,6 +5,7 @@
 use Drupal\Component\Utility\Html;
 use Drupal\Core\Entity\EntityInterface;
 use Drupal\Core\Entity\EntityTypeManagerInterface;
+use Drupal\Core\File\FileUrlGeneratorInterface;
 use Drupal\Core\Logger\LoggerChannelFactoryInterface;
 use Drupal\Core\Plugin\ContainerFactoryPluginInterface;
 use Drupal\Core\Render\BubbleableMetadata;
@@ -68,6 +69,13 @@
   protected $loggerFactory;
 
   /**
+   * The file URL generator.
+   *
+   * @var \Drupal\Core\File\FileUrlGeneratorInterface
+   */
+  protected $fileUrlGenerator;
+
+  /**
    * An array of counters for the recursive rendering protection.
    *
    * Each counter takes into account all the relevant information about the
@@ -96,13 +104,16 @@
    *   The entity embed builder service.
    * @param \Drupal\Core\Logger\LoggerChannelFactoryInterface $logger_factory
    *   The logger factory.
+   * @param \Drupal\Core\File\FileUrlGeneratorInterface
+   *   The file URL generator.
    */
-  public function __construct(array $configuration, $plugin_id, $plugin_definition, EntityTypeManagerInterface $entity_type_manager, RendererInterface $renderer, EntityEmbedBuilderInterface $builder, LoggerChannelFactoryInterface $logger_factory) {
+  public function __construct(array $configuration, $plugin_id, $plugin_definition, EntityTypeManagerInterface $entity_type_manager, RendererInterface $renderer, EntityEmbedBuilderInterface $builder, LoggerChannelFactoryInterface $logger_factory, FileUrlGeneratorInterface $file_url_generator) {
     parent::__construct($configuration, $plugin_id, $plugin_definition);
     $this->entityTypeManager = $entity_type_manager;
     $this->renderer = $renderer;
     $this->builder = $builder;
     $this->loggerFactory = $logger_factory;
+    $this->fileUrlGenerator = $file_url_generator;
   }
 
   /**
@@ -116,7 +127,8 @@
       $container->get('entity_type.manager'),
       $container->get('renderer'),
       $container->get('entity_embed.builder'),
-      $container->get('logger.factory')
+      $container->get('logger.factory'),
+      $container->get('file_url_generator')
     );
   }
 
@@ -158,7 +170,7 @@
           }
           if (!$entity instanceof EntityInterface) {
             $missing_text = $this->t('Missing @type.', ['@type' => $this->entityTypeManager->getDefinition($entity_type)->getSingularLabel()]);
-            $entity_output = '<img src="' . file_url_transform_relative(file_create_url('core/modules/media/images/icons/no-thumbnail.png')) . '" width="180" height="180" alt="' . $missing_text . '" title="' . $missing_text . '"/>';
+            $entity_output = '<img src="' . $this->fileUrlGenerator->generateString('core/modules/media/images/icons/no-thumbnail.png') . '" width="180" height="180" alt="' . $missing_text . '" title="' . $missing_text . '"/>';
             throw new EntityNotFoundException(sprintf('Unable to load embedded %s entity %s.', $entity_type, $id));
           }
         }
diff -ruN a/src/Twig/EntityEmbedTwigExtension.php b/src/Twig/EntityEmbedTwigExtension.php
--- a/src/Twig/EntityEmbedTwigExtension.php	2022-10-20 16:16:12.000000000 +0200
+++ b/src/Twig/EntityEmbedTwigExtension.php	2023-06-08 23:19:27.000000000 +0200
@@ -5,11 +5,13 @@
 use Drupal\Core\Entity\EntityTypeManagerInterface;
 use Drupal\entity_embed\EntityEmbedBuilderInterface;
 use Symfony\Component\DependencyInjection\ContainerInterface;
+use Twig\Extension\AbstractExtension;
+use Twig\TwigFunction;
 
 /**
  * Provide entity embedding function within Twig templates.
  */
-class EntityEmbedTwigExtension extends \Twig_Extension {
+class EntityEmbedTwigExtension extends AbstractExtension {
 
   /**
    * The entity type manager service.
@@ -60,7 +62,7 @@
    */
   public function getFunctions() {
     return [
-      new \Twig_SimpleFunction('entity_embed', [$this, 'getRenderArray']),
+      new TwigFunction('entity_embed', [$this, 'getRenderArray']),
     ];
   }
 
diff -ruN a/tests/fixtures/update/entity_embed.update-hook-test.php b/tests/fixtures/update/entity_embed.update-hook-test.php
--- a/tests/fixtures/update/entity_embed.update-hook-test.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/fixtures/update/entity_embed.update-hook-test.php	1970-01-01 01:00:00.000000000 +0100
@@ -1,55 +0,0 @@
-<?php
-
-/**
- * @file
- * Update hook test file.
- */
-
-use Drupal\Core\Database\Database;
-use Drupal\Component\Serialization\Yaml;
-
-$connection = Database::getConnection();
-
-// Set the schema version.
-$connection->merge('key_value')
-  ->condition('collection', 'system.schema')
-  ->condition('name', 'entity_embed')
-  ->fields([
-    'collection' => 'system.schema',
-    'name' => 'entity_embed',
-    'value' => 's:4:"8001";',
-  ])
-  ->execute();
-
-$config = Yaml::decode(file_get_contents(__DIR__ . '/../../../config/optional/embed.button.node.yml'));
-$connection->insert('config')
-  ->fields([
-    'collection',
-    'name',
-    'data',
-  ])
-  ->values([
-    'collection' => '',
-    'name' => 'embed.button.node',
-    'data' => serialize($config),
-  ])
-  ->execute();
-
-// Update core.extension.
-$extensions = $connection->select('config')
-  ->fields('config', ['data'])
-  ->condition('collection', '')
-  ->condition('name', 'core.extension')
-  ->execute()
-  ->fetchField();
-$extensions = unserialize($extensions);
-$extensions['module']['embed'] = 8000;
-$extensions['module']['entity_embed'] = 8001;
-$extensions['module']['embed'] = 8000;
-$connection->update('config')
-  ->fields([
-    'data' => serialize($extensions),
-  ])
-  ->condition('collection', '')
-  ->condition('name', 'core.extension')
-  ->execute();
diff -ruN a/tests/modules/entity_embed_test/entity_embed_test.info.yml b/tests/modules/entity_embed_test/entity_embed_test.info.yml
--- a/tests/modules/entity_embed_test/entity_embed_test.info.yml	2022-10-20 16:19:04.000000000 +0200
+++ b/tests/modules/entity_embed_test/entity_embed_test.info.yml	2023-06-08 23:18:50.000000000 +0200
@@ -12,8 +12,4 @@
  - drupal:editor
  - embed:embed
  - entity_embed:entity_embed
-
-# Information added by Drupal.org packaging script on 2022-10-20
-version: '8.x-1.3'
-project: 'entity_embed'
-datestamp: 1666275544
+ - ckeditor5:ckeditor5
diff -ruN a/tests/modules/entity_embed_translation_test/entity_embed_translation_test.info.yml b/tests/modules/entity_embed_translation_test/entity_embed_translation_test.info.yml
--- a/tests/modules/entity_embed_translation_test/entity_embed_translation_test.info.yml	2022-10-20 16:19:04.000000000 +0200
+++ b/tests/modules/entity_embed_translation_test/entity_embed_translation_test.info.yml	2023-06-08 23:18:47.000000000 +0200
@@ -13,8 +13,4 @@
  - drupal:editor
  - embed:embed
  - entity_embed:entity_embed
-
-# Information added by Drupal.org packaging script on 2022-10-20
-version: '8.x-1.3'
-project: 'entity_embed'
-datestamp: 1666275544
+ - ckeditor5:ckeditor5
diff -ruN a/tests/src/Functional/EntityEmbedDialogTest.php b/tests/src/Functional/EntityEmbedDialogTest.php
--- a/tests/src/Functional/EntityEmbedDialogTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Functional/EntityEmbedDialogTest.php	2023-06-08 23:19:13.000000000 +0200
@@ -16,7 +16,7 @@
    *
    * @var array
    */
-  public static $modules = ['image'];
+  protected static $modules = ['image'];
 
   /**
    * Tests the entity embed dialog.
diff -ruN a/tests/src/Functional/EntityEmbedDisplayManagerTest.php b/tests/src/Functional/EntityEmbedDisplayManagerTest.php
--- a/tests/src/Functional/EntityEmbedDisplayManagerTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Functional/EntityEmbedDisplayManagerTest.php	2023-06-08 23:19:11.000000000 +0200
@@ -58,7 +58,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $this->imageButton = $this->container->get('entity_type.manager')
diff -ruN a/tests/src/Functional/EntityEmbedEntityBrowserTest.php b/tests/src/Functional/EntityEmbedEntityBrowserTest.php
--- a/tests/src/Functional/EntityEmbedEntityBrowserTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Functional/EntityEmbedEntityBrowserTest.php	2023-06-08 23:19:13.000000000 +0200
@@ -19,7 +19,7 @@
    *
    * @var array
    */
-  public static $modules = ['entity_browser'];
+  protected static $modules = ['entity_browser'];
 
   /**
    * Tests the entity browser integration.
diff -ruN a/tests/src/Functional/EntityEmbedHooksTest.php b/tests/src/Functional/EntityEmbedHooksTest.php
--- a/tests/src/Functional/EntityEmbedHooksTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Functional/EntityEmbedHooksTest.php	2023-06-08 23:19:14.000000000 +0200
@@ -19,7 +19,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
     $this->state = $this->container->get('state');
   }
diff -ruN a/tests/src/Functional/EntityEmbedTestBase.php b/tests/src/Functional/EntityEmbedTestBase.php
--- a/tests/src/Functional/EntityEmbedTestBase.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Functional/EntityEmbedTestBase.php	2023-06-08 23:19:11.000000000 +0200
@@ -50,7 +50,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     // Create a page content type.
diff -ruN a/tests/src/Functional/EntityEmbedTwigTest.php b/tests/src/Functional/EntityEmbedTwigTest.php
--- a/tests/src/Functional/EntityEmbedTwigTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Functional/EntityEmbedTwigTest.php	2023-06-08 23:19:16.000000000 +0200
@@ -14,7 +14,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
     \Drupal::service('theme_installer')->install(['test_theme']);
   }
@@ -34,19 +34,19 @@
   public function testEntityEmbedTwigFunction() {
     // Test embedding a node using entity ID.
     $this->drupalGet('entity_embed_twig_test/id');
-    $this->assertText($this->node->body->value, 'Embedded node exists in page');
+    $this->assertSession()->pageTextContains($this->node->body->value);
 
     // Test 'Label' Entity Embed Display plugin.
     $this->drupalGet('entity_embed_twig_test/label_plugin');
-    $this->assertText($this->node->title->value, 'Title of the embedded node exists in page.');
-    $this->assertNoText($this->node->body->value, 'Body of embedded node does not exists in page when "Label" plugin is used.');
-    $this->assertLinkByHref('node/' . $this->node->id(), 0, 'Link to the embedded node exists when "Label" plugin is used.');
+    $this->assertSession()->pageTextContains($this->node->title->value);
+    $this->assertSession()->pageTextNotContains($this->node->body->value);
+    $this->assertSession()->linkByHrefExists('node/' . $this->node->id(), 0, 'Link to the embedded node exists when "Label" plugin is used.');
 
     // Test 'Label' Entity Embed Display plugin without linking to the node.
     $this->drupalGet('entity_embed_twig_test/label_plugin_no_link');
-    $this->assertText($this->node->title->value, 'Title of the embedded node exists in page.');
-    $this->assertNoText($this->node->body->value, 'Body of embedded node does not exists in page when "Label" plugin is used.');
-    $this->assertNoLinkByHref('node/' . $this->node->id(), 0, 'Link to the embedded node does not exists.');
+    $this->assertSession()->pageTextContains($this->node->title->value);
+    $this->assertSession()->pageTextNotContains($this->node->body->value);
+    $this->assertSession()->linkByHrefNotExists('node/' . $this->node->id(), 0, 'Link to the embedded node does not exists.');
   }
 
 }
diff -ruN a/tests/src/Functional/EntityEmbedUpdateHookTest.php b/tests/src/Functional/EntityEmbedUpdateHookTest.php
--- a/tests/src/Functional/EntityEmbedUpdateHookTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Functional/EntityEmbedUpdateHookTest.php	1970-01-01 01:00:00.000000000 +0100
@@ -1,85 +0,0 @@
-<?php
-
-namespace Drupal\Tests\entity_embed\Functional;
-
-use Drupal\FunctionalTests\Update\UpdatePathTestBase;
-
-/**
- * Tests the update hooks in entity_embed module.
- *
- * @group entity_embed
- */
-class EntityEmbedUpdateHookTest extends UpdatePathTestBase {
-
-  /**
-   * {@inheritdoc}
-   */
-  protected $defaultTheme = 'stark';
-
-  /**
-   * Set database dump files to be used.
-   */
-  protected function setDatabaseDumpFiles() {
-    $this->databaseDumpFiles = [
-      $this->getDrupalRoot() . '/core/modules/system/tests/fixtures/update/drupal-8.8.0.bare.standard.php.gz',
-      __DIR__ . '/../../fixtures/update/entity_embed.update-hook-test.php',
-    ];
-  }
-
-  /**
-   * {@inheritdoc}
-   */
-  protected function setUp() {
-    parent::setUp();
-    $button = $this->container
-      ->get('entity_type.manager')
-      ->getDefinition('embed_button');
-
-    $this->container
-      ->get('entity.last_installed_schema.repository')
-      ->setLastInstalledDefinition($button);
-  }
-
-  /**
-   * {@inheritdoc}
-   */
-  protected function doSelectionTest() {
-    parent::doSelectionTest();
-    $this->assertSession()->responseMatches('/8002\s*-\s*Updates the default mode settings./');
-    $this->assertSession()->responseMatches('/8003\s*-\s*Updates allowed HTML for all filter configs that have an Entity Embed button./');
-  }
-
-  /**
-   * Tests entity_embed_update_8002().
-   */
-  public function todotestPostUpdate() {
-    $this->runUpdates();
-    $mode = $this->container->get('config.factory')
-      ->get('entity_embed.settings')
-      ->get('rendered_entity_mode');
-    $this->assertTrue($mode, 'Render entity mode settings after update is correct.');
-  }
-
-  /**
-   * Tests entity_embed_update_8003().
-   */
-  public function testAllowedAttributes() {
-    $allowed_html = '<drupal-entity data-entity-type data-entity-uuid data-entity-embed-display data-entity-embed-settings data-align data-caption data-embed-button>';
-    $expected_allowed_html = '<drupal-entity data-entity-type data-entity-uuid data-entity-embed-display data-entity-embed-settings data-entity-embed-display-settings data-align data-caption data-embed-button>';
-    $filter_format = $this->container->get('entity_type.manager')->getStorage('filter_format')->load('full_html');
-    $filter_format->setFilterConfig('filter_html', [
-      'status' => TRUE,
-      'settings' => [
-        'allowed_html' => $allowed_html,
-      ],
-    ])->save();
-    $editor = $this->container->get('entity_type.manager')->getStorage('editor')->load('full_html');
-    $button = $this->container->get('entity_type.manager')->getStorage('embed_button')->load('node');
-    $editor->setSettings(['toolbar' => ['rows' => [0 => [0 => ['items' => [0 => $button->id()]]]]]])->save();
-    $this->runUpdates();
-    $filter_format = $this->container->get('entity_type.manager')->getStorage('filter_format')->load('full_html');
-    $filter_html = $filter_format->filters('filter_html');
-    $this->assertEquals($expected_allowed_html, $filter_html->getConfiguration()['settings']['allowed_html'], 'Allowed html is correct');
-  }
-
-}
diff -ruN a/tests/src/Functional/EntityReferenceFieldFormatterTest.php b/tests/src/Functional/EntityReferenceFieldFormatterTest.php
--- a/tests/src/Functional/EntityReferenceFieldFormatterTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Functional/EntityReferenceFieldFormatterTest.php	2023-06-08 23:19:14.000000000 +0200
@@ -21,7 +21,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     // Add a new menu entity which does not has a view controller.
@@ -137,7 +137,7 @@
     $settings['body'] = [['value' => $content, 'format' => 'custom_format']];
     $node = $this->drupalCreateNode($settings);
     $this->drupalGet('node/' . $node->id());
-    $this->assertSession()->responseContains($this->node->body->value, 'Body of embedded node does not exists in page.');
+    $this->assertSession()->responseContains($this->node->body->value);
     $this->assertSession()->responseNotContains('This placeholder should not be rendered.');
   }
 
diff -ruN a/tests/src/Functional/FileFieldFormatterTest.php b/tests/src/Functional/FileFieldFormatterTest.php
--- a/tests/src/Functional/FileFieldFormatterTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Functional/FileFieldFormatterTest.php	2023-06-08 23:19:12.000000000 +0200
@@ -17,7 +17,7 @@
    *
    * @var array
    */
-  public static $modules = ['file', 'image'];
+  protected static $modules = ['file', 'image'];
 
   /**
    * Created file entity.
@@ -29,7 +29,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
     $this->file = $this->getTestFile('text');
   }
@@ -81,7 +81,7 @@
     // Verify description of the embedded file exists in page.
     $this->assertSession()->responseContains($embed_settings['description']);
     $this->assertSession()->responseNotContains('This placeholder should not be rendered.');
-    $this->assertSession()->linkByHrefExists(file_url_transform_relative(file_create_url($this->file->getFileUri())), 0, 'Link to the embedded file exists.');
+    $this->assertSession()->linkByHrefExists(\Drupal::service('file_url_generator')->generateString($this->file->getFileUri()), 0, 'Link to the embedded file exists.');
   }
 
 }
diff -ruN a/tests/src/Functional/ImageFieldFormatterTest.php b/tests/src/Functional/ImageFieldFormatterTest.php
--- a/tests/src/Functional/ImageFieldFormatterTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Functional/ImageFieldFormatterTest.php	2023-06-08 23:19:15.000000000 +0200
@@ -17,7 +17,7 @@
    *
    * @var array
    */
-  public static $modules = ['file', 'image', 'responsive_image'];
+  protected static $modules = ['file', 'image', 'responsive_image'];
 
   /**
    * Created file entity.
@@ -36,7 +36,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
     $this->image = $this->getTestFile('image');
     $this->file = $this->getTestFile('text');
@@ -107,7 +107,7 @@
     // when embed is successful.
     $this->assertSession()->responseContains($alt_text);
     $this->assertSession()->responseNotContains('This placeholder should not be rendered.');
-    $this->assertSession()->linkByHrefExists(file_url_transform_relative(file_create_url($this->image->getFileUri())), 0, 'Link to the embedded image exists.');
+    $this->assertSession()->linkByHrefExists(\Drupal::service('file_url_generator')->generateString($this->image->getFileUri()), 0, 'Link to the embedded image exists.');
 
     // Embed all three field types in one, to ensure they all render correctly.
     $content = '<drupal-entity data-entity-type="node" data-entity-uuid="' . $this->node->uuid() . '" data-entity-embed-display="entity_reference:entity_reference_label"></drupal-entity>';
diff -ruN a/tests/src/FunctionalJavascript/ButtonAdminTest.php b/tests/src/FunctionalJavascript/ButtonAdminTest.php
--- a/tests/src/FunctionalJavascript/ButtonAdminTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/FunctionalJavascript/ButtonAdminTest.php	2023-06-08 23:19:01.000000000 +0200
@@ -39,7 +39,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $this->container
diff -ruN a/tests/src/FunctionalJavascript/CKEditorIntegrationTest.php b/tests/src/FunctionalJavascript/CKEditorIntegrationTest.php
--- a/tests/src/FunctionalJavascript/CKEditorIntegrationTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/FunctionalJavascript/CKEditorIntegrationTest.php	2023-06-08 23:19:06.000000000 +0200
@@ -56,7 +56,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $this->button = $this->container->get('entity_type.manager')
diff -ruN a/tests/src/FunctionalJavascript/ConfigurationUiTest.php b/tests/src/FunctionalJavascript/ConfigurationUiTest.php
--- a/tests/src/FunctionalJavascript/ConfigurationUiTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/FunctionalJavascript/ConfigurationUiTest.php	2023-06-08 23:19:05.000000000 +0200
@@ -17,6 +17,11 @@
   /**
    * {@inheritdoc}
    */
+  protected $failOnJavascriptConsoleErrors = FALSE;
+
+  /**
+   * {@inheritdoc}
+   */
   protected static $modules = [
     'ckeditor',
     'entity_embed',
@@ -32,7 +37,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $format = FilterFormat::create([
diff -ruN a/tests/src/FunctionalJavascript/ContentTranslationTest.php b/tests/src/FunctionalJavascript/ContentTranslationTest.php
--- a/tests/src/FunctionalJavascript/ContentTranslationTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/FunctionalJavascript/ContentTranslationTest.php	2023-06-08 23:19:04.000000000 +0200
@@ -23,12 +23,12 @@
   /**
    * {@inheritdoc}
    */
-  public static $modules = ['entity_embed_translation_test'];
+  protected static $modules = ['entity_embed_translation_test'];
 
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $this->translator = $this->drupalCreateUser([
diff -ruN a/tests/src/FunctionalJavascript/EntityEmbedDialogTest.php b/tests/src/FunctionalJavascript/EntityEmbedDialogTest.php
--- a/tests/src/FunctionalJavascript/EntityEmbedDialogTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/FunctionalJavascript/EntityEmbedDialogTest.php	2023-06-08 23:19:02.000000000 +0200
@@ -18,7 +18,7 @@
    *
    * @var array
    */
-  public static $modules = ['image'];
+  protected static $modules = ['image'];
 
   /**
    * The test user.
@@ -37,7 +37,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     // Create a page content type.
diff -ruN a/tests/src/FunctionalJavascript/ImageFieldFormatterTest.php b/tests/src/FunctionalJavascript/ImageFieldFormatterTest.php
--- a/tests/src/FunctionalJavascript/ImageFieldFormatterTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/FunctionalJavascript/ImageFieldFormatterTest.php	2023-06-08 23:19:05.000000000 +0200
@@ -63,7 +63,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $this->button = $this->container->get('entity_type.manager')
diff -ruN a/tests/src/FunctionalJavascript/MediaImageTest.php b/tests/src/FunctionalJavascript/MediaImageTest.php
--- a/tests/src/FunctionalJavascript/MediaImageTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/FunctionalJavascript/MediaImageTest.php	2023-06-08 23:19:03.000000000 +0200
@@ -45,17 +45,17 @@
   /**
    * {@inheritdoc}
    */
-  protected $defaultTheme = 'stable';
+  protected $defaultTheme = 'stable9';
 
   /**
    * {@inheritdoc}
    */
-  public static $modules = ['entity_embed_test'];
+  protected static $modules = ['entity_embed_test'];
 
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     // Note that media_install() grants 'view media' to all users by default.
@@ -715,7 +715,7 @@
 
     // Configure a different default and admin theme, like on most Drupal sites.
     $this->config('system.theme')
-      ->set('default', 'stable')
+      ->set('default', 'stable9')
       ->set('admin', 'stark')
       ->save();
 
@@ -730,7 +730,7 @@
     $this->getSession()->switchToIFrame('ckeditor');
     $this->assertSession()->waitForElementVisible('css', 'img[src*="image-test.png"]');
     $element = $this->assertSession()->elementExists('css', '[data-entity-embed-test-active-theme]');
-    $this->assertSame('stable', $element->getAttribute('data-entity-embed-test-active-theme'));
+    $this->assertSame('stable9', $element->getAttribute('data-entity-embed-test-active-theme'));
 
     // Assert that the first preview request transferred data over the wire.
     // Then toggle source mode on and off. This causes the CKEditor widget to be
diff -ruN a/tests/src/Kernel/EntityEmbedFilterDisabledIntegrationsTest.php b/tests/src/Kernel/EntityEmbedFilterDisabledIntegrationsTest.php
--- a/tests/src/Kernel/EntityEmbedFilterDisabledIntegrationsTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Kernel/EntityEmbedFilterDisabledIntegrationsTest.php	2023-06-08 23:19:09.000000000 +0200
@@ -15,20 +15,18 @@
    */
   protected static $modules = [
     'contextual',
-    'quickedit',
   ];
 
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $this->installConfig('system');
     $this->container->get('current_user')
       ->addRole($this->drupalCreateRole([
         'access contextual links',
-        'access in-place editing',
       ]));
   }
 
@@ -55,10 +53,7 @@
     return [
       'contextual' => [
         'div.embedded-entity > .contextual-region',
-      ],
-      'quickedit' => [
-        'div.embedded-entity > [data-quickedit-entity-id]',
-      ],
+      ]
     ];
   }
 
diff -ruN a/tests/src/Kernel/EntityEmbedFilterLegacyTest.php b/tests/src/Kernel/EntityEmbedFilterLegacyTest.php
--- a/tests/src/Kernel/EntityEmbedFilterLegacyTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Kernel/EntityEmbedFilterLegacyTest.php	2023-06-08 23:19:08.000000000 +0200
@@ -12,7 +12,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $this->installConfig('system');
diff -ruN a/tests/src/Kernel/EntityEmbedFilterOverridesTest.php b/tests/src/Kernel/EntityEmbedFilterOverridesTest.php
--- a/tests/src/Kernel/EntityEmbedFilterOverridesTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Kernel/EntityEmbedFilterOverridesTest.php	2023-06-08 23:19:09.000000000 +0200
@@ -38,7 +38,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $this->installSchema('file', ['file_usage']);
diff -ruN a/tests/src/Kernel/EntityEmbedFilterTest.php b/tests/src/Kernel/EntityEmbedFilterTest.php
--- a/tests/src/Kernel/EntityEmbedFilterTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Kernel/EntityEmbedFilterTest.php	2023-06-08 23:19:08.000000000 +0200
@@ -24,7 +24,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $this->installConfig('system');
@@ -273,9 +273,10 @@
     /** @var \SimpleXMLElement[] $deleted_embed_warning */
     $deleted_embed_warning = $this->cssSelect('img');
     $this->assertNotEmpty($deleted_embed_warning);
+    $src = \Drupal::service('file_url_generator')->generateString('core/modules/media/images/icons/no-thumbnail.png');
     $this->assertHasAttributes($deleted_embed_warning[0], [
       'alt' => $expected_missing_text,
-      'src' => file_url_transform_relative(file_create_url('core/modules/media/images/icons/no-thumbnail.png')),
+      'src' => $src,
       'title' => $expected_missing_text,
     ]);
   }
diff -ruN a/tests/src/Kernel/EntityEmbedFilterTestBase.php b/tests/src/Kernel/EntityEmbedFilterTestBase.php
--- a/tests/src/Kernel/EntityEmbedFilterTestBase.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Kernel/EntityEmbedFilterTestBase.php	2023-06-08 23:19:10.000000000 +0200
@@ -59,7 +59,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     $this->installSchema('node', 'node_access');
diff -ruN a/tests/src/Kernel/EntityEmbedFilterTranslationTest.php b/tests/src/Kernel/EntityEmbedFilterTranslationTest.php
--- a/tests/src/Kernel/EntityEmbedFilterTranslationTest.php	2022-10-20 16:16:12.000000000 +0200
+++ b/tests/src/Kernel/EntityEmbedFilterTranslationTest.php	2023-06-08 23:19:06.000000000 +0200
@@ -22,7 +22,7 @@
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
 
     ConfigurableLanguage::createFromLangcode('pt-br')->save();
diff -ruN a/webpack.config.js b/webpack.config.js
--- a/webpack.config.js	1970-01-01 01:00:00.000000000 +0100
+++ b/webpack.config.js	2023-06-08 23:18:41.000000000 +0200
@@ -0,0 +1,65 @@
+const path = require('path');
+const fs = require('fs');
+const webpack = require('webpack');
+const TerserPlugin = require('terser-webpack-plugin');
+
+function getDirectories(srcpath) {
+  return fs
+    .readdirSync(srcpath)
+    .filter((item) => fs.statSync(path.join(srcpath, item)).isDirectory());
+}
+
+module.exports = [];
+// Loop through every subdirectory in src, each a different plugin, and build
+// each one in ./build.
+getDirectories('./js/ckeditor5_plugins').forEach((dir) => {
+  const bc = {
+    mode: 'production',
+    optimization: {
+      minimize: true,
+      minimizer: [
+        new TerserPlugin({
+          terserOptions: {
+            format: {
+              comments: false,
+            },
+          },
+          test: /\.js(\?.*)?$/i,
+          extractComments: false,
+        }),
+      ],
+      moduleIds: 'named',
+    },
+    entry: {
+      path: path.resolve(
+        __dirname,
+        'js/ckeditor5_plugins',
+        dir,
+        'src/index.js',
+      ),
+    },
+    output: {
+      path: path.resolve(__dirname, './js/build'),
+      filename: `${dir}.js`,
+      library: ['CKEditor5', dir],
+      libraryTarget: 'umd',
+      libraryExport: 'default',
+    },
+    plugins: [
+      // It is possible to require the ckeditor5-dll.manifest.json used in
+      // core/node_modules rather than having to install CKEditor 5 here.
+      // However, that requires knowing the location of that file relative to
+      // where your module code is located.
+      new webpack.DllReferencePlugin({
+        manifest: require('./node_modules/ckeditor5/build/ckeditor5-dll.manifest.json'), // eslint-disable-line global-require, import/no-unresolved
+        scope: 'ckeditor5/src',
+        name: 'CKEditor5.dll',
+      }),
+    ],
+    module: {
+      rules: [{ test: /\.svg$/, use: 'raw-loader' }],
+    },
+  };
+
+  module.exports.push(bc);
+});
